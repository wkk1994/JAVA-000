# 学习笔记

## 第 23 课作业实践

### 1、（必做）配置redis的主从复制，sentinel高可用，Cluster集群。 提交如下内容到github：

* 1）config配置文件；
  
  redis主从复制：
  * 创建网络: `docker network create redis_repl`
  * redis各节点配置

    节点1：
    docker-compose.yml:

    ```yml
      version: "3"
      services:
        redis:
          image: redis:5.0.2
          ports:
            - 6001:6001
          volumes:
            - $PWD/data:/data
            - $PWD/conf:/usr/local/etc/redis
          command: redis-server /usr/local/etc/redis/redis.conf
          networks:
            redis_repl:
              aliases:
                - redis_master
      networks:
        redis_repl:
          external:
            name: "redis_repl"
     ```

     redis.conf

     ```text
     # redis端口
     port 6001
     # 关闭保护模式
     protected-mode no
     # 开启集群
     # 开启 appendonly 备份模式
     appendonly yes
     # 每秒钟备份
     appendfsync everysec
     # 对aof文件进行压缩时，是否执行同步操作
     no-appendfsync-on-rewrite no
     # 当目前aof文件大小超过上一次重写时的aof文件大小的100%时会再次进行重写
     auto-aof-rewrite-percentage 100
     # 重写前AOF文件的大小最小值 默认 64mb
     auto-aof-rewrite-min-size 64mb
     ```

    节点2：
    docker-compose.yml: 修改端口 6001 -> 6002
    redis.conf: 修改端口 6001 -> 6002

    节点3：
    docker-compose.yml: 修改端口 6001 -> 6003
    redis.conf: 修改端口 6001 -> 6003

  * 在节点2和节点3分别执行`replicaof ip port`，建立主从复制。ip和port分别为节点1的ip和port。

  redis sentinel高可用
  
  * redis各节点配置
    哨兵1：
    docker-compose.yml

      ```yml
      version: "3"
      services:
        redis:
          image: redis:5.0.2
          ports:
            - 5001:5001
          volumes:
            - $PWD/data:/data
            - $PWD/conf/sentinel.conf:/path/to/sentinel.conf
          command: redis-sentinel /path/to/sentinel.conf
          networks:
            redis_repl:
              aliases:
                - redis_sentinel1
      networks:
        redis_repl:
          external:
            name: "redis_repl"
      ```

     redis.conf

     ```text
     sentinel deny-scripts-reconfig yes
     # 主从库断连的最大连接超时时间
     sentinel monitor mymaster 47.98.190.67 6001 2
     # Generated by CONFIG REWRITE
     protected-mode no
     port 5001
     sentinel down-after-milliseconds mymaster 10000
     sentinel config-epoch mymaster 5
     ```

    哨兵2：
    docker-compose.yml: 修改端口 5001 -> 5002
    redis.conf: 修改端口 5001 -> 5002

    哨兵3：
    docker-compose.yml: 修改端口 5001 -> 5003
    redis.conf: 修改端口 5001 -> 5003

  redis cluster集群：
  * 创建网络: `docker network create redis_net`
  * redis各节点配置

    节点1：
    docker-compose.yml:

    ```yml
      version: "3"
      services:
        redis:
          image: redis:5.0.2
          ports:
            - 7001:7001
            - 17001:17001
          volumes:
            - $PWD/data:/data
            - $PWD/conf:/usr/local/etc/redis
          command: redis-server /usr/local/etc/redis/redis.conf
          networks:
            redis_net:
              aliases:
                - redis_node1
      networks:
        default:
          external:
            name: redis_net
     ```

     redis.conf

     ```text
     # redis端口
     port 7001
     # 关闭保护模式
     protected-mode no
     # 开启集群
     cluster-enabled yes
     # 集群节点配置
     cluster-config-file nodes.conf
     # 超时
     cluster-node-timeout 5000
     # 集群节点端口 7001 - 7006
     cluster-announce-port 7001
     cluster-announce-bus-port 17001
     # 开启 appendonly 备份模式
     appendonly yes
     # 每秒钟备份
     appendfsync everysec
     # 对aof文件进行压缩时，是否执行同步操作
     no-appendfsync-on-rewrite no
     # 当目前aof文件大小超过上一次重写时的aof文件大小的100%时会再次进行重写
     auto-aof-rewrite-percentage 100
     # 重写前AOF文件的大小最小值 默认 64mb
     auto-aof-rewrite-min-size 64mb
     ```

    节点2：
    docker-compose.yml: 修改端口 7001 -> 7002; 17001 -> 17002
    redis.conf: 修改端口 7001 -> 7002; 17001 -> 17002

    节点3：
    docker-compose.yml: 修改端口 7001 -> 7003; 17001 -> 17003
    redis.conf: 修改端口 7001 -> 7003; 17001 -> 17003

    节点4：
    docker-compose.yml: 修改端口 7001 -> 7004; 17001 -> 17004
    redis.conf: 修改端口 7001 -> 7004; 17001 -> 17004

    节点5：
    docker-compose.yml: 修改端口 7001 -> 7005; 17001 -> 17005
    redis.conf: 修改端口 7001 -> 7005; 17001 -> 17005

    节点6：
    docker-compose.yml: 修改端口 7001 -> 7006; 17001 -> 17006
    redis.conf: 修改端口 7001 -> 7006; 17001 -> 17006

  * 或取各个节点的ip地址：`docker network inspect redis_net`，在任意节点执行：`redis-cli -p 7001 --cluster create 172.30.0.2:7001 172.30.0.3:7002 172.30.0.4:7003 172.30.0.5:7004 172.30.0.6:7005 172.30.0.7:7006 --cluster-replicas 1`，建立redis集群。

* 2）启动和操作、验证集群下数据读写的命令步骤。
